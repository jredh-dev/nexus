---
import Base from '../layouts/Base.astro';
import Topbar from '../components/Topbar.astro';
import type { APIContext } from 'astro';
import { proxyToPortal } from '../lib/proxy';

// Proxy POST /signup to the portal backend.
// Astro 5 requires an exported POST function to accept POST on a page route â€”
// without it the Node adapter returns 405 before middleware fires.
export async function POST(context: APIContext): Promise<Response> {
  return proxyToPortal(context.request, '/signup');
}

const error = Astro.url.searchParams.get('error') || '';
---

<Base title="Sign Up">
    <Topbar slot="topbar" />

    <section class="auth-page">
        <div class="auth-container">
            <h1 class="title is-4 has-text-centered" style="font-family: 'Montserrat', sans-serif;">Create Account</h1>
            <p class="subtitle is-6 is-muted has-text-centered mb-5">Join Hooper Development</p>

            <div class="box auth-card">
                {error && (
                    <div class="notification is-danger is-light">
                        <span class="icon"><i class="fas fa-exclamation-circle"></i></span>
                        {error}
                    </div>
                )}
                <form action="/signup" method="POST">
                    <div class="field">
                        <label class="label" for="username" style="font-size: 0.9rem;">Username</label>
                        <div class="control has-icons-left">
                            <input class="input" type="text" id="username" name="username" placeholder="jsmith" required>
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-at"></i></span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="name" style="font-size: 0.9rem;">Full Name</label>
                        <div class="control has-icons-left">
                            <input class="input" type="text" id="name" name="name" placeholder="John Smith">
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-user"></i></span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="email" style="font-size: 0.9rem;">Email</label>
                        <div class="control has-icons-left">
                            <input class="input" type="email" id="email" name="email" placeholder="you@example.com" required>
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-envelope"></i></span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="phone" style="font-size: 0.9rem;">Phone Number</label>
                        <div class="control has-icons-left">
                            <input class="input" type="tel" id="phone" name="phone" placeholder="(555) 123-4567" required>
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-phone"></i></span>
                        </div>
                    </div>
                    <div class="field">
                        <label class="label" for="password" style="font-size: 0.9rem;">Password</label>
                        <div class="control has-icons-left">
                            <input class="input" type="password" id="password" name="password" required>
                            <span class="icon is-small is-left" style="color: var(--fresh-muted);"><i class="fas fa-lock"></i></span>
                        </div>
                    </div>
                    <div class="field mt-5">
                        <button class="button primary-btn is-rounded is-fullwidth cta" type="submit">
                            Create Account
                        </button>
                    </div>
                </form>
            </div>
            <p class="has-text-centered has-text-fresh-muted mt-4" style="font-size: 0.9rem;">
                Already have an account? <a href="/login" style="color: var(--fresh-primary);">Login</a>
            </p>
        </div>
    </section>
</Base>

<style>
    .auth-page {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 52px);
        padding: 2rem 1rem;
    }
    .auth-container {
        width: 100%;
        max-width: 420px;
    }
</style>
