---
import Base from '../layouts/Base.astro';
import Topbar from '../components/Topbar.astro';

// TODO: Fetch user/session data via Connect RPC AuthService.GetSession
const sessionCookie = Astro.cookies.get('session');
if (!sessionCookie?.value) {
    return Astro.redirect('/login');
}

// Placeholder user data - will come from GetSession RPC
const user = {
    username: '',
    name: 'User',
    email: '',
    phoneNumber: '',
    createdAt: new Date(),
    lastLoginAt: new Date(),
};

interface Session {
    ipAddress: string;
    userAgent: string;
    createdAt: Date;
    expiresAt: Date;
}

const sessions: Session[] = [];
---

<Base title="Dashboard">
    <Topbar slot="topbar" />

    <section class="section">
        <div class="container">
            <div class="columns is-centered">
                <div class="column is-10">
                    <h1 class="title is-3" style="font-family: 'Montserrat', sans-serif;">Dashboard</h1>
                    <p class="subtitle is-6 is-muted">Welcome back, {user.name}</p>
                    <div class="divider mb-5"></div>

                    <div class="columns">
                        <!-- Profile -->
                        <div class="column is-4">
                            <div class="box" style="border-radius: 8px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                                <h2 class="title is-5 mb-4">Profile</h2>
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                        {user.username && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Username</th>
                                                <td style="color: var(--fresh-muted);">{user.username}</td>
                                            </tr>
                                        )}
                                        <tr>
                                            <th style="color: var(--fresh-dark);">Email</th>
                                            <td style="color: var(--fresh-muted);">{user.email}</td>
                                        </tr>
                                        {user.phoneNumber && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Phone</th>
                                                <td style="color: var(--fresh-muted);">{user.phoneNumber}</td>
                                            </tr>
                                        )}
                                        <tr>
                                            <th style="color: var(--fresh-dark);">Name</th>
                                            <td style="color: var(--fresh-muted);">{user.name}</td>
                                        </tr>
                                        <tr>
                                            <th style="color: var(--fresh-dark);">Member since</th>
                                            <td style="color: var(--fresh-muted);">{user.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                                        </tr>
                                        <tr>
                                            <th style="color: var(--fresh-dark);">Last login</th>
                                            <td style="color: var(--fresh-muted);">{user.lastLoginAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="mt-4">
                                    <a class="button secondary-btn btn-outlined is-rounded is-fullwidth" href="/logout">
                                        <span class="icon"><i class="fas fa-right-from-bracket"></i></span>
                                        <span>Logout</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Sessions -->
                        <div class="column is-8">
                            <div class="box" style="border-radius: 8px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                                <h2 class="title is-5 mb-4">Active Sessions</h2>
                                {sessions.length > 0 ? (
                                    <div class="table-container">
                                        <table class="table is-fullwidth is-striped is-hoverable">
                                            <thead>
                                                <tr>
                                                    <th>IP Address</th>
                                                    <th>User Agent</th>
                                                    <th>Created</th>
                                                    <th>Expires</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {sessions.map(session => (
                                                    <tr>
                                                        <td>{session.ipAddress}</td>
                                                        <td class="is-size-7 has-text-fresh-muted">{session.userAgent}</td>
                                                        <td style="color: var(--fresh-muted);">{session.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}</td>
                                                        <td style="color: var(--fresh-muted);">{session.expiresAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <p class="has-text-fresh-muted">No active sessions.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</Base>
