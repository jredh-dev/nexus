---
import Base from '../layouts/Base.astro';
import Topbar from '../components/Topbar.astro';
import { createConnectTransport } from '@connectrpc/connect-web';
import { createClient } from '@connectrpc/connect';
import { AuthService } from '../gen/portal/v1/auth_pb.js';
import { getPortalUrl } from '../lib/proxy';

// Redirect to login if no session cookie present.
const sessionCookie = Astro.cookies.get('session');
if (!sessionCookie?.value) {
    return Astro.redirect('/login');
}

// Call GetSession via Connect RPC, forwarding the session cookie.
// In SSR, we talk directly to the portal backend (bypasses Astro middleware).
const portalUrl = getPortalUrl();

const transport = createConnectTransport({
    baseUrl: portalUrl,
    fetch: (input, init) => fetch(input, {
        ...init,
        headers: {
            ...Object.fromEntries(new Headers(init?.headers ?? {})),
            Cookie: `session=${sessionCookie.value}`,
        },
    }),
});

const client = createClient(AuthService, transport);

let user = { username: '', name: 'User', email: '', phone: '', createdAt: '', lastLogin: '' };
let sessions: { ipAddress: string; userAgent: string; createdAt: string; expiresAt: string }[] = [];

try {
    const resp = await client.getSession({});
    if (resp.user) {
        user = {
            username: resp.user.username,
            name: resp.user.name || resp.user.username || 'User',
            email: resp.user.email,
            phone: resp.user.phone,
            createdAt: resp.user.createdAt,
            lastLogin: resp.user.lastLogin,
        };
    }
    sessions = resp.sessions.map(s => ({
        ipAddress: s.ipAddress,
        userAgent: s.userAgent,
        createdAt: s.createdAt,
        expiresAt: s.expiresAt,
    }));
} catch (err) {
    // Session invalid — redirect to login.
    return Astro.redirect('/login');
}

function fmtDate(iso: string): string {
    if (!iso) return '—';
    try {
        return new Date(iso).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric',
        });
    } catch { return iso; }
}

function fmtDateTime(iso: string): string {
    if (!iso) return '—';
    try {
        return new Date(iso).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit',
        });
    } catch { return iso; }
}
---

<Base title="Dashboard">
    <Topbar slot="topbar" />

    <section class="section">
        <div class="container">
            <div class="columns is-centered">
                <div class="column is-10">
                    <h1 class="title is-3" style="font-family: 'Montserrat', sans-serif;">Dashboard</h1>
                    <p class="subtitle is-6 is-muted">Welcome back, {user.name}</p>
                    <div class="divider mb-5"></div>

                    <div class="columns">
                        <!-- Profile -->
                        <div class="column is-4">
                            <div class="box" style="border-radius: 8px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                                <h2 class="title is-5 mb-4">Profile</h2>
                                <table class="table is-fullwidth is-narrow">
                                    <tbody>
                                        {user.username && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Username</th>
                                                <td style="color: var(--fresh-muted);">{user.username}</td>
                                            </tr>
                                        )}
                                        <tr>
                                            <th style="color: var(--fresh-dark);">Email</th>
                                            <td style="color: var(--fresh-muted);">{user.email}</td>
                                        </tr>
                                        {user.phone && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Phone</th>
                                                <td style="color: var(--fresh-muted);">{user.phone}</td>
                                            </tr>
                                        )}
                                        {user.name && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Name</th>
                                                <td style="color: var(--fresh-muted);">{user.name}</td>
                                            </tr>
                                        )}
                                        {user.createdAt && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Member since</th>
                                                <td style="color: var(--fresh-muted);">{fmtDate(user.createdAt)}</td>
                                            </tr>
                                        )}
                                        {user.lastLogin && (
                                            <tr>
                                                <th style="color: var(--fresh-dark);">Last login</th>
                                                <td style="color: var(--fresh-muted);">{fmtDateTime(user.lastLogin)}</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                                <div class="mt-4">
                                    <a class="button secondary-btn btn-outlined is-rounded is-fullwidth" href="/logout">
                                        <span class="icon"><i class="fas fa-right-from-bracket"></i></span>
                                        <span>Logout</span>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Sessions -->
                        <div class="column is-8">
                            <div class="box" style="border-radius: 8px; border: none; box-shadow: 0 2px 12px rgba(0,0,0,0.06);">
                                <h2 class="title is-5 mb-4">Active Sessions</h2>
                                {sessions.length > 0 ? (
                                    <div class="table-container">
                                        <table class="table is-fullwidth is-striped is-hoverable">
                                            <thead>
                                                <tr>
                                                    <th>IP Address</th>
                                                    <th>User Agent</th>
                                                    <th>Created</th>
                                                    <th>Expires</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {sessions.map(session => (
                                                    <tr>
                                                        <td>{session.ipAddress}</td>
                                                        <td class="is-size-7 has-text-fresh-muted">{session.userAgent}</td>
                                                        <td style="color: var(--fresh-muted);">{fmtDateTime(session.createdAt)}</td>
                                                        <td style="color: var(--fresh-muted);">{fmtDateTime(session.expiresAt)}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <p class="has-text-fresh-muted">No active sessions.</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</Base>
